<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgriStock - Gestion de Stock Agricole</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Day.js -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/fr.min.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2c8c47',
                        secondary: '#f0b429',
                        accent: '#e74c3c',
                        background: '#f8f9fa',
                        dark: '#2c3e50',
                    }
                }
            }
        }
    </script>
    <style>
        .slide-fade-enter-active {
            transition: all 0.3s ease-out;
        }
        .slide-fade-leave-active {
            transition: all 0.3s cubic-bezier(1, 0.5, 0.8, 1);
        }
        .slide-fade-enter-from,
        .slide-fade-leave-to {
            transform: translateX(20px);
            opacity: 0;
        }
        .page-enter-active, .page-leave-active {
            transition: opacity 0.3s;
        }
        .page-enter, .page-leave-to {
            opacity: 0;
        }
        .image-preview {
            max-height: 200px;
            object-fit: contain;
        }
        .chart-container {
            height: 300px;
        }
    </style>
</head>
<body class="bg-background min-h-screen font-sans">
    <!-- Navigation -->
    <nav class="bg-primary text-white shadow-lg">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-tractor text-2xl"></i>
                    <span class="font-bold text-xl">AgriStock</span>
                </div>
                <div class="hidden md:flex space-x-8">
                    <button data-page="dashboard" class="nav-btn active-page py-2 px-4 rounded-lg hover:bg-white hover:text-primary transition">Tableau de bord</button>
                    <button data-page="products" class="nav-btn py-2 px-4 rounded-lg hover:bg-white hover:text-primary transition">Produits</button>
                    <button data-page="suppliers" class="nav-btn py-2 px-4 rounded-lg hover:bg-white hover:text-primary transition">Fournisseurs</button>
                    <button data-page="sales" class="nav-btn py-2 px-4 rounded-lg hover:bg-white hover:text-primary transition">Ventes</button>
                </div>
                <div class="flex items-center space-x-4">
                    <button class="md:hidden text-white focus:outline-none" id="mobile-menu-button">
                        <i class="fas fa-bars text-2xl"></i>
                    </button>
                </div>
            </div>
        </div>
        <!-- Mobile menu -->
        <div class="hidden md:hidden bg-primary-dark" id="mobile-menu">
            <div class="flex flex-col py-2">
                <button data-page="dashboard" class="nav-btn active-page py-3 px-6 hover:bg-white hover:text-primary">Tableau de bord</button>
                <button data-page="products" class="nav-btn py-3 px-6 hover:bg-white hover:text-primary">Produits</button>
                <button data-page="suppliers" class="nav-btn py-3 px-6 hover:bg-white hover:text-primary">Fournisseurs</button>
                <button data-page="sales" class="nav-btn py-3 px-6 hover:bg-white hover:text-primary">Ventes</button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Dashboard Page -->
        <div id="dashboard-page" class="page">
            <h1 class="text-3xl font-bold text-dark mb-6">Tableau de Bord</h1>
            
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-primary">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-gray-500">Produits</p>
                            <h3 class="text-3xl font-bold" id="total-products">0</h3>
                        </div>
                        <i class="fas fa-boxes text-primary text-4xl"></i>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-secondary">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-gray-500">Fournisseurs</p>
                            <h3 class="text-3xl font-bold" id="total-suppliers">0</h3>
                        </div>
                        <i class="fas fa-truck text-secondary text-4xl"></i>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-accent">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-gray-500">Stock Total</p>
                            <h3 class="text-3xl font-bold" id="total-stock">0</h3>
                        </div>
                        <i class="fas fa-warehouse text-accent text-4xl"></i>
                    </div>
                </div>
            </div>
            
            <!-- Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-bold text-dark mb-4">Évolution des Ventes</h2>
                    <div class="chart-container">
                        <canvas id="sales-chart"></canvas>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-bold text-dark mb-4">Répartition des Stocks</h2>
                    <div class="chart-container">
                        <canvas id="stock-chart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Low Stock Products -->
            <div class="bg-white p-6 rounded-xl shadow-md">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-dark">Produits en Rupture ou Faible Stock</h2>
                    <span class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm font-medium" id="low-stock-count">0 produits</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Produit</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock Actuel</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dernière Vente</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Statut</th>
                            </tr>
                        </thead>
                        <tbody id="low-stock-list" class="bg-white divide-y divide-gray-200">
                            <!-- Low stock items will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Products Page -->
        <div id="products-page" class="page hidden">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-dark">Gestion des Produits</h1>
                <button id="add-product-btn" class="bg-primary hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center">
                    <i class="fas fa-plus mr-2"></i> Ajouter un produit
                </button>
            </div>
            
            <div class="bg-white rounded-xl shadow-md overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Image</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Produit</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Prix (MAD)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date d'ajout</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="products-list" class="bg-white divide-y divide-gray-200">
                            <!-- Products will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Suppliers Page -->
        <div id="suppliers-page" class="page hidden">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-dark">Gestion des Fournisseurs</h1>
                <button id="add-supplier-btn" class="bg-primary hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center">
                    <i class="fas fa-plus mr-2"></i> Ajouter un fournisseur
                </button>
            </div>
            
            <div class="bg-white rounded-xl shadow-md overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nom</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Téléphone</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contrat</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="suppliers-list" class="bg-white divide-y divide-gray-200">
                            <!-- Suppliers will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Sales Page -->
        <div id="sales-page" class="page hidden">
            <h1 class="text-3xl font-bold text-dark mb-6">Suivi des Ventes</h1>
            
            <div class="mb-6">
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-bold text-dark mb-4">Enregistrer une Vente</h2>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="sale-product">Produit</label>
                            <select id="sale-product" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                                <option value="">Sélectionner un produit</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="sale-quantity">Quantité</label>
                            <input type="number" id="sale-quantity" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" min="1" value="1">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="sale-date">Date</label>
                            <input type="datetime-local" id="sale-date" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                        </div>
                        <div class="flex items-end">
                            <button id="record-sale-btn" class="w-full bg-primary hover:bg-green-700 text-white px-4 py-2 rounded-lg h-[42px]">
                                Enregistrer
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-xl shadow-md">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-dark">Historique des Ventes</h2>
                    <div class="flex space-x-2">
                        <select id="sales-period" class="px-3 py-1 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                            <option value="7">7 derniers jours</option>
                            <option value="30">30 derniers jours</option>
                            <option value="90">3 derniers mois</option>
                            <option value="all">Toutes les ventes</option>
                        </select>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Produit</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantité</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Montant (MAD)</th>
                            </tr>
                        </thead>
                        <tbody id="sales-list" class="bg-white divide-y divide-gray-200">
                            <!-- Sales will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Modals -->
    <!-- Product Modal -->
    <div id="product-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold text-dark" id="product-modal-title">Ajouter un produit</h3>
                    <button id="close-product-modal" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form id="product-form" class="space-y-4">
                    <input type="hidden" id="product-id">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="md:col-span-2">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="product-image">Image du produit</label>
                            <input type="file" id="product-image" accept="image/*" class="w-full">
                            <div class="mt-2">
                                <img id="product-image-preview" src="" alt="Aperçu" class="image-preview hidden w-full rounded-lg border">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="product-title">Nom du produit *</label>
                            <input type="text" id="product-title" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="product-price">Prix (MAD) *</label>
                            <input type="number" id="product-price" step="0.01" min="0" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="product-quantity">Quantité en stock *</label>
                            <input type="number" id="product-quantity" min="0" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="product-date">Date d'ajout</label>
                            <input type="date" id="product-date" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-4 pt-4">
                        <button type="button" id="cancel-product" class="px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-100">Annuler</button>
                        <button type="submit" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-green-700">Enregistrer</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Supplier Modal -->
    <div id="supplier-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold text-dark" id="supplier-modal-title">Ajouter un fournisseur</h3>
                    <button id="close-supplier-modal" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form id="supplier-form" class="space-y-4">
                    <input type="hidden" id="supplier-id">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="supplier-name">Nom du fournisseur *</label>
                            <input type="text" id="supplier-name" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="supplier-phone">Téléphone *</label>
                            <input type="tel" id="supplier-phone" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="supplier-email">Email</label>
                            <input type="email" id="supplier-email" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                        </div>
                        
                        <div class="md:col-span-2">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="supplier-contract">Contrat (PDF ou image)</label>
                            <input type="file" id="supplier-contract" accept=".pdf,.jpg,.jpeg,.png" class="w-full">
                            <div class="mt-2">
                                <div id="contract-preview" class="hidden p-4 bg-gray-100 rounded-lg">
                                    <i class="fas fa-file-pdf text-red-500 text-4xl"></i>
                                    <p class="mt-2 text-sm" id="contract-filename"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-4 pt-4">
                        <button type="button" id="cancel-supplier" class="px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-100">Annuler</button>
                        <button type="submit" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-green-700">Enregistrer</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-md">
            <div class="p-6">
                <div class="text-center">
                    <i class="fas fa-exclamation-circle text-5xl text-accent mb-4"></i>
                    <h3 class="text-xl font-bold text-dark mb-2" id="confirmation-title">Confirmer la suppression</h3>
                    <p class="text-gray-600 mb-6" id="confirmation-message">Êtes-vous sûr de vouloir supprimer cet élément ? Cette action est irréversible.</p>
                    
                    <div class="flex justify-center space-x-4">
                        <button id="cancel-confirm" class="px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-100">Annuler</button>
                        <button id="confirm-action" class="px-4 py-2 bg-accent text-white rounded-lg hover:bg-red-700">Supprimer</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Set Day.js locale to French
        dayjs.locale('fr');
        
        // Initialize data structures
        let products = JSON.parse(localStorage.getItem('products')) || [];
        let suppliers = JSON.parse(localStorage.getItem('suppliers')) || [];
        let sales = JSON.parse(localStorage.getItem('sales')) || [];
        
        // DOM Elements
        const pages = {
            dashboard: document.getElementById('dashboard-page'),
            products: document.getElementById('products-page'),
            suppliers: document.getElementById('suppliers-page'),
            sales: document.getElementById('sales-page')
        };
        
        const navButtons = document.querySelectorAll('.nav-btn');
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        
        // Dashboard elements
        const totalProducts = document.getElementById('total-products');
        const totalSuppliers = document.getElementById('total-suppliers');
        const totalStock = document.getElementById('total-stock');
        const lowStockCount = document.getElementById('low-stock-count');
        const lowStockList = document.getElementById('low-stock-list');
        
        // Products elements
        const productsList = document.getElementById('products-list');
        const addProductBtn = document.getElementById('add-product-btn');
        const productModal = document.getElementById('product-modal');
        const productForm = document.getElementById('product-form');
        const productImage = document.getElementById('product-image');
        const productImagePreview = document.getElementById('product-image-preview');
        
        // Suppliers elements
        const suppliersList = document.getElementById('suppliers-list');
        const addSupplierBtn = document.getElementById('add-supplier-btn');
        const supplierModal = document.getElementById('supplier-modal');
        const supplierForm = document.getElementById('supplier-form');
        const supplierContract = document.getElementById('supplier-contract');
        const contractPreview = document.getElementById('contract-preview');
        const contractFilename = document.getElementById('contract-filename');
        
        // Sales elements
        const saleProduct = document.getElementById('sale-product');
        const salesList = document.getElementById('sales-list');
        const salesPeriod = document.getElementById('sales-period');
        const recordSaleBtn = document.getElementById('record-sale-btn');
        
        // Confirmation modal
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmActionBtn = document.getElementById('confirm-action');
        const cancelConfirmBtn = document.getElementById('cancel-confirm');
        const confirmationTitle = document.getElementById('confirmation-title');
        const confirmationMessage = document.getElementById('confirmation-message');
        
        // Chart instances
        let salesChart = null;
        let stockChart = null;
        
        // Current context for deletion
        let currentDeleteContext = { type: null, id: null };
        
        // Initialize application
        function initApp() {
            // Set today's date as default for sales
            const now = new Date();
            const formattedDateTime = now.toISOString().slice(0, 16);
            document.getElementById('sale-date').value = formattedDateTime;
            
            // Load initial data
            loadDashboard();
            loadProducts();
            loadSuppliers();
            loadSales();
            populateProductSelect();
            
            // Set event listeners
            setupEventListeners();
            
            // Show dashboard by default
            showPage('dashboard');
        }
        
        // Set up event listeners
        function setupEventListeners() {
            // Navigation
            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    showPage(button.dataset.page);
                });
            });
            
            // Mobile menu
            mobileMenuButton.addEventListener('click', () => {
                mobileMenu.classList.toggle('hidden');
            });
            
            // Product modal
            addProductBtn.addEventListener('click', () => openProductModal());
            document.getElementById('close-product-modal').addEventListener('click', () => closeProductModal());
            document.getElementById('cancel-product').addEventListener('click', () => closeProductModal());
            
            // Product image preview
            productImage.addEventListener('change', function(e) {
                if (this.files && this.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        productImagePreview.src = e.target.result;
                        productImagePreview.classList.remove('hidden');
                    }
                    reader.readAsDataURL(this.files[0]);
                }
            });
            
            // Product form submit
            productForm.addEventListener('submit', saveProduct);
            
            // Supplier modal
            addSupplierBtn.addEventListener('click', () => openSupplierModal());
            document.getElementById('close-supplier-modal').addEventListener('click', () => closeSupplierModal());
            document.getElementById('cancel-supplier').addEventListener('click', () => closeSupplierModal());
            
            // Supplier contract preview
            supplierContract.addEventListener('change', function(e) {
                if (this.files && this.files[0]) {
                    contractFilename.textContent = this.files[0].name;
                    contractPreview.classList.remove('hidden');
                }
            });
            
            // Supplier form submit
            supplierForm.addEventListener('submit', saveSupplier);
            
            // Record sale
            recordSaleBtn.addEventListener('click', recordSale);
            
            // Sales period filter
            salesPeriod.addEventListener('change', loadSales);
            
            // Confirmation modal
            cancelConfirmBtn.addEventListener('click', () => confirmationModal.classList.add('hidden'));
            confirmActionBtn.addEventListener('click', () => {
                if (currentDeleteContext.type === 'product') {
                    deleteProduct(currentDeleteContext.id);
                } else if (currentDeleteContext.type === 'supplier') {
                    deleteSupplier(currentDeleteContext.id);
                }
                confirmationModal.classList.add('hidden');
            });
        }
        
        // Show a specific page
        function showPage(pageName) {
            // Hide all pages
            Object.values(pages).forEach(page => page.classList.add('hidden'));
            
            // Show requested page
            pages[pageName].classList.remove('hidden');
            
            // Update active nav button
            navButtons.forEach(button => {
                button.classList.remove('active-page');
                if (button.dataset.page === pageName) {
                    button.classList.add('active-page');
                }
            });
            
            // Close mobile menu
            mobileMenu.classList.add('hidden');
            
            // Update charts if dashboard
            if (pageName === 'dashboard') {
                setTimeout(() => {
                    if (salesChart) salesChart.destroy();
                    if (stockChart) stockChart.destroy();
                    initCharts();
                }, 100);
            }
        }
        
        // Load dashboard data
        function loadDashboard() {
            // Update stats
            totalProducts.textContent = products.length;
            totalSuppliers.textContent = suppliers.length;
            
            const totalStockValue = products.reduce((sum, product) => sum + product.quantity, 0);
            totalStock.textContent = totalStockValue;
            
            // Find low stock products (quantity <= 5)
            const lowStockProducts = products.filter(product => product.quantity <= 5);
            lowStockCount.textContent = `${lowStockProducts.length} produits`;
            
            // Display low stock products
            lowStockList.innerHTML = '';
            if (lowStockProducts.length === 0) {
                lowStockList.innerHTML = `
                    <tr>
                        <td colspan="4" class="px-6 py-4 text-center text-gray-500">
                            Aucun produit en rupture ou faible stock
                        </td>
                    </tr>
                `;
            } else {
                lowStockProducts.forEach(product => {
                    // Find the most recent sale for this product
                    const productSales = sales.filter(sale => sale.productId === product.id);
                    productSales.sort((a, b) => new Date(b.date) - new Date(a.date));
                    const lastSale = productSales[0];
                    
                    const status = product.quantity === 0 ? 
                        '<span class="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs font-medium">Rupture</span>' : 
                        '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-medium">Faible stock</span>';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-10 w-10">
                                    <img class="h-10 w-10 rounded-full object-cover" src="${product.image || 'https://via.placeholder.com/150'}" alt="${product.title}">
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">${product.title}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">${product.quantity}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${lastSale ? dayjs(lastSale.date).format('DD/MM/YYYY HH:mm') : 'Jamais'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            ${status}
                        </td>
                    `;
                    lowStockList.appendChild(row);
                });
            }
            
            // Initialize charts
            initCharts();
        }
        
        // Initialize charts
        function initCharts() {
            const salesCtx = document.getElementById('sales-chart').getContext('2d');
            const stockCtx = document.getElementById('stock-chart').getContext('2d');
            
            // Sales chart data - last 7 days
            const dates = [];
            const salesData = [];
            
            // Generate dates for the last 7 days
            for (let i = 6; i >= 0; i--) {
                const date = dayjs().subtract(i, 'day').format('DD/MM');
                dates.push(date);
                
                // Find sales for this date
                const salesOnDate = sales.filter(sale => {
                    const saleDate = dayjs(sale.date).format('YYYY-MM-DD');
                    const targetDate = dayjs().subtract(i, 'day').format('YYYY-MM-DD');
                    return saleDate === targetDate;
                });
                
                // Calculate total quantity sold on this date
                const totalQuantity = salesOnDate.reduce((sum, sale) => sum + sale.quantity, 0);
                salesData.push(totalQuantity);
            }
            
            // Calculate percentage change
            const lastDay = salesData[salesData.length - 1] || 0;
            const prevDay = salesData[salesData.length - 2] || 0;
            let percentageChange = 0;
            
            if (prevDay > 0) {
                percentageChange = Math.round(((lastDay - prevDay) / prevDay) * 100);
            } else if (lastDay > 0) {
                percentageChange = 100;
            }
            
            salesChart = new Chart(salesCtx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Quantité vendue',
                        data: salesData,
                        borderColor: '#2c8c47',
                        backgroundColor: 'rgba(44, 140, 71, 0.1)',
                        borderWidth: 2,
                        pointBackgroundColor: '#2c8c47',
                        pointRadius: 4,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `Évolution des ventes: ${percentageChange >= 0 ? '+' : ''}${percentageChange}%`,
                            font: {
                                size: 16
                            }
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Quantité vendue'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        }
                    }
                }
            });
            
            // Stock chart - top 5 products by quantity
            const sortedProducts = [...products].sort((a, b) => b.quantity - a.quantity).slice(0, 5);
            const stockLabels = sortedProducts.map(p => p.title);
            const stockData = sortedProducts.map(p => p.quantity);
            
            stockChart = new Chart(stockCtx, {
                type: 'bar',
                data: {
                    labels: stockLabels,
                    datasets: [{
                        label: 'Quantité en stock',
                        data: stockData,
                        backgroundColor: '#f0b429',
                        borderColor: '#d19d08',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Quantité'
                            }
                        }
                    }
                }
            });
        }
        
        // Load products
        function loadProducts() {
            productsList.innerHTML = '';
            
            if (products.length === 0) {
                productsList.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                            Aucun produit enregistré. Ajoutez votre premier produit.
                        </td>
                    </tr>
                `;
                return;
            }
            
            products.forEach(product => {
                const stockStatus = product.quantity === 0 ? 
                    '<span class="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs font-medium">Rupture</span>' : 
                    product.quantity <= 5 ? 
                    '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-medium">Faible</span>' : 
                    '<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium">Disponible</span>';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex-shrink-0 h-10 w-10">
                            <img class="h-10 w-10 rounded-full object-cover" src="${product.image || 'https://via.placeholder.com/150'}" alt="${product.title}">
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm font-medium text-gray-900">${product.title}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${product.price.toFixed(2)} DH</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${product.quantity}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${dayjs(product.dateAdded).format('DD/MM/YYYY')}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="edit-product text-primary hover:text-green-700 mr-3" data-id="${product.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="delete-product text-accent hover:text-red-700" data-id="${product.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                productsList.appendChild(row);
            });
            
            // Add event listeners to edit/delete buttons
            document.querySelectorAll('.edit-product').forEach(btn => {
                btn.addEventListener('click', () => {
                    const productId = btn.dataset.id;
                    const product = products.find(p => p.id === productId);
                    openProductModal(product);
                });
            });
            
            document.querySelectorAll('.delete-product').forEach(btn => {
                btn.addEventListener('click', () => {
                    const productId = btn.dataset.id;
                    const product = products.find(p => p.id === productId);
                    showConfirmationModal('Supprimer un produit', `Êtes-vous sûr de vouloir supprimer le produit "${product.title}" ?`, 'product', productId);
                });
            });
        }
        
        // Open product modal for adding or editing
        function openProductModal(product = null) {
            const modalTitle = document.getElementById('product-modal-title');
            const form = document.getElementById('product-form');
            
            if (product) {
                modalTitle.textContent = 'Modifier le produit';
                document.getElementById('product-id').value = product.id;
                document.getElementById('product-title').value = product.title;
                document.getElementById('product-price').value = product.price;
                document.getElementById('product-quantity').value = product.quantity;
                document.getElementById('product-date').value = dayjs(product.dateAdded).format('YYYY-MM-DD');
                
                if (product.image) {
                    productImagePreview.src = product.image;
                    productImagePreview.classList.remove('hidden');
                } else {
                    productImagePreview.classList.add('hidden');
                }
            } else {
                modalTitle.textContent = 'Ajouter un produit';
                form.reset();
                productImagePreview.classList.add('hidden');
                document.getElementById('product-date').valueAsDate = new Date();
            }
            
            productModal.classList.remove('hidden');
        }
        
        // Close product modal
        function closeProductModal() {
            productModal.classList.add('hidden');
        }
        
        // Save product
        function saveProduct(e) {
            e.preventDefault();
            
            const id = document.getElementById('product-id').value;
            const title = document.getElementById('product-title').value;
            const price = parseFloat(document.getElementById('product-price').value);
            const quantity = parseInt(document.getElementById('product-quantity').value);
            const dateAdded = document.getElementById('product-date').value || new Date().toISOString();
            const image = productImagePreview.src || '';
            
            if (!title || isNaN(price) || isNaN(quantity)) {
                alert('Veuillez remplir tous les champs obligatoires correctement');
                return;
            }
            
            const product = {
                id: id || Date.now().toString(),
                title,
                price,
                quantity,
                dateAdded,
                image
            };
            
            if (id) {
                // Update existing product
                const index = products.findIndex(p => p.id === id);
                if (index !== -1) {
                    products[index] = product;
                }
            } else {
                // Add new product
                products.push(product);
            }
            
            saveProductsToStorage();
            loadProducts();
            loadDashboard();
            closeProductModal();
        }
        
        // Delete product
        function deleteProduct(id) {
            products = products.filter(product => product.id !== id);
            saveProductsToStorage();
            loadProducts();
            loadDashboard();
            populateProductSelect();
        }
        
        // Save products to localStorage
        function saveProductsToStorage() {
            localStorage.setItem('products', JSON.stringify(products));
        }
        
        // Load suppliers
        function loadSuppliers() {
            suppliersList.innerHTML = '';
            
            if (suppliers.length === 0) {
                suppliersList.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                            Aucun fournisseur enregistré. Ajoutez votre premier fournisseur.
                        </td>
                    </tr>
                `;
                return;
            }
            
            suppliers.forEach(supplier => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4">
                        <div class="text-sm font-medium text-gray-900">${supplier.name}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${supplier.phone}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm text-gray-900">${supplier.email || '-'}</div>
                    </td>
                    <td class="px-6 py-4">
                        ${supplier.contract ? 
                            `<a href="#" class="text-primary hover:text-green-700 text-sm view-contract" data-contract="${supplier.contract}">
                                <i class="fas fa-file-pdf mr-1"></i> Voir contrat
                            </a>` : 
                            '<span class="text-sm text-gray-500">Aucun</span>'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="edit-supplier text-primary hover:text-green-700 mr-3" data-id="${supplier.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="delete-supplier text-accent hover:text-red-700" data-id="${supplier.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                suppliersList.appendChild(row);
            });
            
            // Add event listeners to edit/delete buttons
            document.querySelectorAll('.edit-supplier').forEach(btn => {
                btn.addEventListener('click', () => {
                    const supplierId = btn.dataset.id;
                    const supplier = suppliers.find(s => s.id === supplierId);
                    openSupplierModal(supplier);
                });
            });
            
            document.querySelectorAll('.delete-supplier').forEach(btn => {
                btn.addEventListener('click', () => {
                    const supplierId = btn.dataset.id;
                    const supplier = suppliers.find(s => s.id === supplierId);
                    showConfirmationModal('Supprimer un fournisseur', `Êtes-vous sûr de vouloir supprimer le fournisseur "${supplier.name}" ?`, 'supplier', supplierId);
                });
            });
        }
        
        // Open supplier modal for adding or editing
        function openSupplierModal(supplier = null) {
            const modalTitle = document.getElementById('supplier-modal-title');
            const form = document.getElementById('supplier-form');
            
            if (supplier) {
                modalTitle.textContent = 'Modifier le fournisseur';
                document.getElementById('supplier-id').value = supplier.id;
                document.getElementById('supplier-name').value = supplier.name;
                document.getElementById('supplier-phone').value = supplier.phone;
                document.getElementById('supplier-email').value = supplier.email || '';
                
                if (supplier.contract) {
                    contractFilename.textContent = 'Contrat existant';
                    contractPreview.classList.remove('hidden');
                } else {
                    contractPreview.classList.add('hidden');
                }
            } else {
                modalTitle.textContent = 'Ajouter un fournisseur';
                form.reset();
                contractPreview.classList.add('hidden');
            }
            
            supplierModal.classList.remove('hidden');
        }
        
        // Close supplier modal
        function closeSupplierModal() {
            supplierModal.classList.add('hidden');
        }
        
        // Save supplier
        function saveSupplier(e) {
            e.preventDefault();
            
            const id = document.getElementById('supplier-id').value;
            const name = document.getElementById('supplier-name').value;
            const phone = document.getElementById('supplier-phone').value;
            const email = document.getElementById('supplier-email').value;
            
            if (!name || !phone) {
                alert('Veuillez remplir les champs obligatoires (Nom et Téléphone)');
                return;
            }
            
            // Handle contract file if selected
            let contract = null;
            if (supplierContract.files.length > 0) {
                const file = supplierContract.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    contract = e.target.result;
                    saveSupplierData(id, name, phone, email, contract);
                };
                reader.readAsDataURL(file);
            } else {
                // If editing and contract already exists, keep it
                if (id) {
                    const existingSupplier = suppliers.find(s => s.id === id);
                    contract = existingSupplier.contract || null;
                }
                saveSupplierData(id, name, phone, email, contract);
            }
        }
        
        function saveSupplierData(id, name, phone, email, contract) {
            const supplier = {
                id: id || Date.now().toString(),
                name,
                phone,
                email: email || '',
                contract
            };
            
            if (id) {
                // Update existing supplier
                const index = suppliers.findIndex(s => s.id === id);
                if (index !== -1) {
                    suppliers[index] = supplier;
                }
            } else {
                // Add new supplier
                suppliers.push(supplier);
            }
            
            saveSuppliersToStorage();
            loadSuppliers();
            closeSupplierModal();
        }
        
        // Delete supplier
        function deleteSupplier(id) {
            suppliers = suppliers.filter(supplier => supplier.id !== id);
            saveSuppliersToStorage();
            loadSuppliers();
        }
        
        // Save suppliers to localStorage
        function saveSuppliersToStorage() {
            localStorage.setItem('suppliers', JSON.stringify(suppliers));
        }
        
        // Load sales
        function loadSales() {
            const period = salesPeriod.value;
            let filteredSales = [...sales];
            
            if (period !== 'all') {
                const days = parseInt(period);
                const cutoffDate = dayjs().subtract(days, 'day');
                filteredSales = sales.filter(sale => dayjs(sale.date).isAfter(cutoffDate));
            }
            
            // Sort by date descending
            filteredSales.sort((a, b) => dayjs(b.date).unix() - dayjs(a.date).unix());
            
            salesList.innerHTML = '';
            
            if (filteredSales.length === 0) {
                salesList.innerHTML = `
                    <tr>
                        <td colspan="4" class="px-6 py-4 text-center text-gray-500">
                            Aucune vente enregistrée pour cette période
                        </td>
                    </tr>
                `;
                return;
            }
            
            filteredSales.forEach(sale => {
                const product = products.find(p => p.id === sale.productId);
                const productName = product ? product.title : 'Produit supprimé';
                const amount = product ? (product.price * sale.quantity).toFixed(2) : '0.00';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${dayjs(sale.date).format('DD/MM/YYYY HH:mm')}
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm font-medium text-gray-900">${productName}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${sale.quantity}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${amount} DH
                    </td>
                `;
                salesList.appendChild(row);
            });
        }
        
        // Record a sale
        function recordSale() {
            const productId = saleProduct.value;
            const quantity = parseInt(document.getElementById('sale-quantity').value);
            const date = document.getElementById('sale-date').value;
            
            if (!productId || isNaN(quantity) || quantity <= 0) {
                alert('Veuillez sélectionner un produit et saisir une quantité valide');
                return;
            }
            
            const product = products.find(p => p.id === productId);
            if (!product) {
                alert('Produit introuvable');
                return;
            }
            
            if (product.quantity < quantity) {
                alert(`Stock insuffisant. Stock disponible: ${product.quantity}`);
                return;
            }
            
            // Update product stock
            product.quantity -= quantity;
            product.lastSale = new Date().toISOString();
            
            // Record sale
            const sale = {
                id: Date.now().toString(),
                productId,
                quantity,
                date: date || new Date().toISOString()
            };
            
            sales.push(sale);
            
            // Save to storage
            saveProductsToStorage();
            localStorage.setItem('sales', JSON.stringify(sales));
            
            // Update UI
            loadProducts();
            loadDashboard();
            loadSales();
            populateProductSelect();
            
            // Reset form
            document.getElementById('sale-quantity').value = 1;
            
            // Show success message
            const successAlert = document.createElement('div');
            successAlert.className = 'fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded z-50';
            successAlert.innerHTML = `
                <span class="block sm:inline">Vente enregistrée avec succès !</span>
                <span class="absolute top-0 bottom-0 right-0 px-4 py-3">
                    <i class="fas fa-times cursor-pointer" onclick="this.parentElement.parentElement.remove()"></i>
                </span>
            `;
            document.body.appendChild(successAlert);
            
            // Remove alert after 3 seconds
            setTimeout(() => {
                successAlert.remove();
            }, 3000);
        }
        
        // Populate product select for sales
        function populateProductSelect() {
            saleProduct.innerHTML = '<option value="">Sélectionner un produit</option>';
            
            products.forEach(product => {
                if (product.quantity > 0) {
                    const option = document.createElement('option');
                    option.value = product.id;
                    option.textContent = `${product.title} (${product.quantity} en stock)`;
                    saleProduct.appendChild(option);
                }
            });
        }
        
        // Show confirmation modal
        function showConfirmationModal(title, message, type, id) {
            confirmationTitle.textContent = title;
            confirmationMessage.textContent = message;
            currentDeleteContext = { type, id };
            confirmationModal.classList.remove('hidden');
        }
        
        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>